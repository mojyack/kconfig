v=6.16.8
# see ../regular-update for environment setup

# download files
curl -OL https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$v.tar.xz
tar -xf linux-$v.tar.xz
git clone --depth=1 https://source.mnt.re/reform/reform-debian-packages.git
git clone --depth=1 https://source.mnt.re/reform/reform-tools.git

# patches
cd linux-$v
# print firmware
curl 'https://732852.bugs.gentoo.org/attachment.cgi?id=649432' | patch -p1
# mnt patches
for patch in ../reform-debian-packages/linux/patches${v%.*}/rk3588-mnt-reform2/*.patch ../reform-debian-packages/linux/patches${v%.*}/imx8mp-mnt-pocket-reform/pocket-panel/0001-v5-add-multi-display-panel-driver.patch; do
    patch -p1 < "$patch" || break
done
# add dtb
patch -d ../reform-debian-packages -p1 < $repo/memo/mnt-pocket-reform/dts-remove-clock-props.patch
cp ../reform-debian-packages/linux/rk3588-mnt-pocket-reform.dts arch/arm64/boot/dts/rockchip
echo 'dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588-mnt-pocket-reform.dtb' >>  arch/arm64/boot/dts/rockchip/Makefile

# build
# see ../regular-update for source setup
kmake Image &&
kmake modules &&
kmake dtbs &&
rkmake modules_install &&
doas cp $W/arch/arm64/boot/Image $D/boot/vmlinuz &&
doas cp $W/arch/arm64/boot/dts/rockchip/rk3588-mnt-pocket-reform.dtb $D/boot/dtb

# lpc
pathc -d ../reform-tools -p1 < ~/build/kconfig/memo/mnt-pocket-reform/lpc-force-v2.patch
kmake M=$PWD/../reform-tools/lpc modules
rkmake M=$PWD/../reform-tools/lpc modules_install
